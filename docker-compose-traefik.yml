version: '3.8'

# ğŸ³ Docker Compose Ğ´Ğ»Ñ SlideConfirm Ñ Traefik
# 
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
# 1. ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ .env Ñ„Ğ°Ğ¹Ğ» (DOMAIN, SECRET_KEY, DB_PASSWORD)
# 2. docker-compose up -d
# 3. ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° https://DOMAIN

services:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Backend (FastAPI)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: slideconfirm-backend
    
    environment:
      # Database
      - DATABASE_URL=postgresql://slideconfirm:${DB_PASSWORD}@db:5432/slideconfirm
      
      # Security
      - SECRET_KEY=${SECRET_KEY}
      - ENVIRONMENT=${ENVIRONMENT}
      
      # API
      - VITE_API_URL=https://${DOMAIN}/api
      - LOG_LEVEL=${LOG_LEVEL}
      
      # Python
      - PYTHONUNBUFFERED=1
    
    volumes:
      # Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
      - ./data/uploads:/tmp/slideconfirm_uploads
      # Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
      - ./logs/backend:/app/logs
    
    depends_on:
      db:
        condition: service_healthy
    
    restart: unless-stopped
    
    # âœ… Ğ’ĞĞ–ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑ‚ÑŒ Traefik
    networks:
      - traefik-net
    
    # Health check Ğ´Ğ»Ñ Docker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # âœ… Labels Ğ´Ğ»Ñ Traefik Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    labels:
      # Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Traefik Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
      - "traefik.enable=true"
      
      # ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚: domain.com/api/* Ğ¸Ğ´ĞµÑ‚ Ğ½Ğ° backend
      - "traefik.http.routers.slideconfirm-backend.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      
      # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ HTTPS
      - "traefik.http.routers.slideconfirm-backend.entrypoints=websecure"
      
      # Let's Encrypt ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚
      - "traefik.http.routers.slideconfirm-backend.tls.certresolver=letsencrypt"
      
      # Port ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
      - "traefik.http.services.slideconfirm-backend.loadbalancer.server.port=8000"
      
      # Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ /api Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ€Ğ¾ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
      - "traefik.http.middlewares.api-prefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.slideconfirm-backend.middlewares=api-prefix"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Frontend (Nginx + React)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: slideconfirm-frontend
    
    restart: unless-stopped
    
    # âœ… Ğ’ĞĞ–ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑ‚ÑŒ Traefik
    networks:
      - traefik-net
    
    depends_on:
      - backend
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # âœ… Labels Ğ´Ğ»Ñ Traefik Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    labels:
      # Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Traefik
      - "traefik.enable=true"
      
      # ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚: domain.com Ğ¸Ğ´ĞµÑ‚ Ğ½Ğ° frontend
      - "traefik.http.routers.slideconfirm-frontend.rule=Host(`${DOMAIN}`)"
      
      # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ HTTPS
      - "traefik.http.routers.slideconfirm-frontend.entrypoints=websecure"
      
      # Let's Encrypt ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚
      - "traefik.http.routers.slideconfirm-frontend.tls.certresolver=letsencrypt"
      
      # Port ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
      - "traefik.http.services.slideconfirm-frontend.loadbalancer.server.port=80"
      
      # ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ° (Ğ±Ğ¾Ğ»ĞµĞµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚ /api Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚)
      - "traefik.http.routers.slideconfirm-frontend.priority=1"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Database (PostgreSQL)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  db:
    image: postgres:15-alpine
    container_name: slideconfirm-db
    
    environment:
      - POSTGRES_DB=slideconfirm
      - POSTGRES_USER=slideconfirm
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=en_US.UTF-8
    
    volumes:
      # Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ‘Ğ” (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞ»Ğ¸ÑÑŒ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°Ğ¼Ğ¸)
      - db_data:/var/lib/postgresql/data
      # Ğ›Ğ¾Ğ³Ğ¸ Ğ‘Ğ” (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
      - ./logs/postgres:/var/log/postgresql
    
    restart: unless-stopped
    
    # âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑ‚ÑŒ Traefik (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ backend Ğ¼Ğ¾Ğ³ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ)
    networks:
      - traefik-net
    
    # Health check Ğ´Ğ»Ñ Ğ‘Ğ”
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U slideconfirm -d slideconfirm"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Networks
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

networks:
  traefik-net:
    external: true  # âœ… Ğ’ĞĞ–ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ®Ğ©Ğ£Ğ® ÑĞµÑ‚ÑŒ Traefik
                     # Ğ•ÑĞ»Ğ¸ ÑĞµÑ‚Ğ¸ Ğ½ĞµÑ‚, ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ:
                     # docker network create traefik-net

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Volumes
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

volumes:
  db_data:
    driver: local

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞŸĞ Ğ˜ĞœĞ•Ğ§ĞĞĞ˜Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. ĞŸĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ .env Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸:
#    - DOMAIN=yourdomain.com
#    - SECRET_KEY=very-secure-key-here
#    - DB_PASSWORD=strong-db-password
#    - ENVIRONMENT=production
#    - LOG_LEVEL=info
#
# 2. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ñ‡Ñ‚Ğ¾ Traefik Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸ ÑĞµÑ‚ÑŒ traefik-net ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚:
#    docker network ls | grep traefik-net
#
# 3. Ğ•ÑĞ»Ğ¸ ÑĞµÑ‚Ğ¸ Ğ½ĞµÑ‚, ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞµÑ‘:
#    docker network create traefik-net
#
# 4. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ:
#    docker-compose up -d
#
# 5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸:
#    docker-compose logs -f
#
# 6. ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ°:
#    https://yourdomain.com (frontend)
#    https://yourdomain.com/api/health (API)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
